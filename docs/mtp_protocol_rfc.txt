RFC - MysticType Protocol (MTP)

Author: Quentin Hivanhoe, Loic Rabearivelo, Nicolas Samy, Emma Frederic
Contact: mysticType@epitech.eu
Version: 1.0
Date: 20 November 2025

================================================================================
1. Introduction
================================================================================

1.1 Purpose
-----------
This document specifies the MysticType Protocol (MTP), a lightweight 
application-layer protocol designed for real-time multiplayer game 
communication over UDP.

1.2 Scope
---------
MTP provides a simple, efficient packet structure for client-server and 
peer-to-peer game networking, with support for connection management, data 
transmission, and heartbeat mechanisms.

1.3 Terminology
---------------
- Magic Number: A fixed 2-byte identifier used to validate protocol compliance
- Payload: Variable-length data carried by a packet (0-255 bytes)
- Header: Fixed 4-byte structure containing packet metadata
- Packet: Complete transmission unit consisting of header and optional payload

================================================================================
2. Protocol Overview
================================================================================

2.1 Design Goals
----------------
- Minimal overhead for real-time applications
- Simple implementation and parsing
- UDP-compatible for low-latency transmission
- Extensible packet type system

2.2 Transport Layer
-------------------
MTP operates over UDP (User Datagram Protocol) on the transport layer. The 
protocol does not provide reliability guarantees; applications requiring 
reliable delivery must implement acknowledgment and retransmission mechanisms.

================================================================================
3. Packet Structure
================================================================================

3.1 General Format
------------------
All MTP packets consist of a fixed-size header followed by an optional 
variable-size payload:

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Magic Number          | Packet Type  |  Payload Size  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
|                        Payload (0-255 bytes)                  |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

3.2 Header Fields
-----------------

3.2.1 Magic Number (16 bits)
- Offset: 0
- Length: 2 bytes
- Value: 0xCAFE (fixed constant)
- Byte Order: Network byte order (big-endian)
- Purpose: Protocol identification and validation

3.2.2 Packet Type (8 bits)
- Offset: 3
- Length: 1 byte
- Purpose: Identifies the packet type (see Section 4)

3.2.3 Payload Size (8 bits)
- Offset: 2
- Length: 1 byte
- Purpose: Specifies payload length in bytes

3.3 Payload
-----------
- Length: Variable (0 to 255 bytes)
- Format: Type-specific binary data
- Position: Immediately following the header

================================================================================
4. Packet Types
================================================================================

4.1 Type Registry
-----------------

Value | Type Name      | Description
------|----------------|--------------------------------------
0x01  | CONNECTION     | Client connection request
0x02  | DISCONNECTION  | Client disconnection notification
0x03  | MOVE           | Player movement data transmission
0xFF  | IOERROR          | Error notification

4.2 Type Definitions
--------------------

4.2.1 CONNECTION (0x01)
Purpose: Initiates a connection between client and server

Payload Format:
 0                   1
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Client ID            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Payload Fields:
- Client ID (optional, 1 byte): Unique client identifier

Expected Response: ACK packet with assigned client ID

4.2.2 DISCONNECTION (0x02)
Purpose: Graceful connection termination

Payload Format:
 0                   1
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Client ID            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Payload Fields:
- Client ID (1 byte): ID of disconnecting client

Expected Response: None

4.2.3 MOVE (0x03)
Purpose: Player movement data transmission

Payload Format:
 0                   1                   2
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Player ID    | Position X    | Position Y   |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
| Velocity X   | Velocity Y    | Direction    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Payload Fields:
- Player ID (1 byte): ID of the moving player
- Position X (1 byte): X coordinate
- Position Y (1 byte): Y coordinate
- Velocity X (1 byte): X velocity component
- Velocity Y (1 byte): Y velocity component
- Direction (1 byte): Facing direction (0-255 = 0-360°)

Usage: Sent by clients to update their position, broadcasted by server to 
other clients

4.2.4 IOERROR (0xFF)
Purpose: Error condition notification

Payload Format:
 0                   1
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|         Error Code            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

Payload Fields:
- Error Code (1 byte): Application-defined error identifier

Common Error Codes:
- 0x00: Generic error
- 0x01: Invalid packet format
- 0x02: Authentication failure
- 0xFF: Server full

================================================================================
5. Protocol Operations
================================================================================

5.1 Connection Establishment
----------------------------
Client                          Server
  |                               |
  |--- CONNECTION --------------->|
  |                               |
  |<-- ACK (Client ID) -----------|
  |                               |

5.2 Connection Termination
--------------------------
Client                          Server
  |                               |
  |--- DISCONNECTION ------------>|
  |                               |
  [Connection closed]             |

5.3 Movement Data Exchange
--------------------------
Client                          Server
  |                               |
  |--- MOVE --------------------->|
  |                               |
  |<-- MOVE (broadcast) ----------|
  |                               |

================================================================================
6. Implementation Considerations
================================================================================

6.1 Byte Order
--------------
All multi-byte fields MUST be transmitted in network byte order (big-endian). 
Implementations MUST use appropriate conversion functions (htons/ntohs).

6.2 Validation
--------------
Receivers MUST validate:
1. Packet length (minimum 4 bytes)
2. Magic number (0xCAFE)
3. Payload size matches received data
4. Packet type is recognized

Invalid packets MUST be silently discarded.

6.3 Maximum Transmission Unit
------------------------------
The maximum packet size is 259 bytes (4-byte header + 255-byte payload). 
Implementations SHOULD ensure this fits within the network MTU to avoid 
fragmentation.

6.4 Timeout Handling
--------------------
Implementations SHOULD implement timeouts for:
- Connection establishment (recommended: 5 seconds)
- Heartbeat response (recommended: 30 seconds)
- Idle connection cleanup (recommended: 60 seconds)

6.5 Security Considerations
---------------------------
This protocol does NOT provide:
- Authentication
- Encryption
- Message integrity verification

Implementations requiring security MUST implement these at a higher layer 
(e.g., DTLS over UDP).

================================================================================
7. Extensibility
================================================================================

7.1 Reserved Packet Types
-------------------------
Types 0x06-0xFE are reserved for future protocol extensions.

7.2 Custom Packet Types
-----------------------
Applications MAY define custom packet types in the reserved range for 
experimental features, but MUST NOT expect interoperability with other 
implementations.

================================================================================
8. Example Packets
================================================================================

8.1 CONNECTION Packet
---------------------
Hexadecimal: CA FE 01 01 2A
Breakdown:
  CA FE      - Magic number (0xCAFE)
  01         - Payload size (1 byte)
  01         - Packet type (CONNECTION)
  2A         - Payload: Client ID = 42

8.2 MOVE Packet
---------------
Hexadecimal: CA FE 08 03 01 0A 14 1E 02 01 FF B4
Breakdown:
  CA FE      - Magic number (0xCAFE)
  08         - Payload size (8 bytes)
  03         - Packet type (MOVE)
  01         - Player ID = 1
  0A         - Position X = 10
  14         - Position Y = 20
  1E         - Position Z = 30
  02         - Velocity X = 2
  01         - Velocity Y = 1
  FF         - Velocity Z = -1 (255 in unsigned)
  B4         - Direction = 180° (180 * 255/360 ≈ 180)

================================================================================
9. References
================================================================================

- RFC 768: User Datagram Protocol
- RFC 791: Internet Protocol
- POSIX Socket API Documentation

================================================================================
Appendix A: Implementation Checklist
================================================================================

- [ ] Packet header serialization (network byte order)
- [ ] Packet header deserialization (network byte order)
- [ ] Magic number validation
- [ ] Packet type enumeration
- [ ] Payload size validation
- [ ] Connection state management
- [ ] Heartbeat mechanism
- [ ] Error handling
- [ ] Timeout implementation
- [ ] Unit tests for packet parsing

================================================================================
10. Addendum: Lobby-aware Routing (2025-03)
================================================================================

In the current Mystic-Type implementation, UDP packets remain unchanged but are
logically scoped per lobby:

- The TCP handshake assigns each player to a lobby (see tcp_protocol_rfc.txt).
- The server routes HELLO_UDP/INPUT/SHOOT/SNAPSHOT using the lobby associated
  to the player's session; each lobby has its own authoritative GameWorld.
- Clients do not need to include the lobby code in UDP payloads; routing is done
  server-side via the player ID → lobby mapping established over TCP.
