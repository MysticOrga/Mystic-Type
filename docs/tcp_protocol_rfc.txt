Mystic-Type TCP Protocol (Informal RFC)
======================================

Version: 1.1 (Lobby extension)
Status: Draft
Author: Mystic-Type Networking Team
Date: 2025

--------------------------------------
1. Introduction
--------------------------------------

This document defines the Mystic-Type TCP Protocol, a lightweight
binary protocol used exclusively for:

- Client connection
- Handshake validation
- Assignment of player ID
- Heartbeat / keepalive (PING/PONG)
- Lobby creation / join signaling
- Lobby-scoped player list updates

All gameplay data is transmitted over UDP, not TCP.

This protocol ensures reliable connection negotiation only.

--------------------------------------
2. Transport and Framing
--------------------------------------

Transport layer: TCP stream.

Each message sent over TCP is a framed binary packet defined as:

  [0-1] : header_magic  (uint16, always 0x5254 = "RT")
  [2]   : type          (uint8)
  [3]   : size          (uint8, payload length 0..255)
  [4..] : payload       (0..255 bytes)

All integers use big-endian (network byte order).

Maximum payload = 255 bytes.


--------------------------------------
3. Packet Types
--------------------------------------

PacketType enumeration:

  1 : SERVER_HELLO
  2 : CLIENT_HELLO
  3 : OK
  4 : REFUSED
  5 : PING
  6 : PONG
  7 : MESSAGE
  8 : PLAYER_LIST
  9 : NEW_PLAYER
 14 : CREATE_LOBBY
 15 : JOIN_LOBBY
 16 : LOBBY_OK
 17 : LOBBY_ERROR

Details:

SERVER_HELLO (1)
  Payload: ASCII text, typically "R-Type Server"
CLIENT_HELLO (2)
  Payload must begin with "toto"
OK (3)
  Payload: 2 bytes (big-endian player ID)
REFUSED (4)
  Payload: ASCII reason (e.g., "FULL", "TIMEOUT", ...)
PING (5)
  No payload
PONG (6)
  No payload
MESSAGE (7)
  Free-form application-defined payload
PLAYER_LIST (8)
  Payload:
    [0]     : count (uint8)
    Then for each player:
      [id_hi][id_lo][posX][posY]
  Lists only players inside the same lobby as the recipient.
NEW_PLAYER (9)
  Payload: [id_hi][id_lo][posX][posY]
  Broadcast to lobby members when a new player joins their lobby.
CREATE_LOBBY (14)
  Sent by client after OK to create a private lobby with a join code.
  Payload: empty
JOIN_LOBBY (15)
  Sent by client after OK to join a friend's lobby.
  Payload: ASCII code (exactly the code returned by LOBBY_OK)
LOBBY_OK (16)
  Payload: ASCII lobby code (6 chars recommended)
  Returned after CREATE_LOBBY or JOIN_LOBBY; also used for auto-match.
LOBBY_ERROR (17)
  Payload: ASCII reason: "UNKNOWN_CODE", "FULL", "INVALID_STATE"


--------------------------------------
4. Connection Handshake
--------------------------------------

Handshake sequence:

1) Server → SERVER_HELLO("R-Type Server")
2) Client → CLIENT_HELLO("toto...")

If valid:
3) Server → OK(player_id)
4) Lobby selection (Section 4.1)

Else:
3) Server → REFUSED(reason)
4) Server closes connection.

Refusal reasons:

- "TIMEOUT"     → no data from client within 3 seconds
- "NO_DATA"     → client closed the socket
- "BAD_PACKET"  → deserialize error, bad magic or truncated
- "BAD_HANDSHAKE" → wrong type or payload not starting with "toto"
- "FULL"        → server capacity = 4 clients


--------------------------------------
4.1 Lobby Selection (post-handshake)
--------------------------------------

After receiving OK(player_id), the client must choose one of:

- Auto-match public lobby (default): send nothing. Server assigns the
  player to a non-full public lobby (or creates one) and replies
  LOBBY_OK(code).
- Create private lobby: Client → CREATE_LOBBY. Server creates a private
  lobby, reserves a slot for the player, and replies LOBBY_OK(code).
- Join friend: Client → JOIN_LOBBY(code). Server replies LOBBY_OK(code)
  on success or LOBBY_ERROR(reason) otherwise.

The lobby code is ASCII (6 chars recommended, alnum). All subsequent TCP
signals (PLAYER_LIST, NEW_PLAYER) are scoped to the player's lobby.

Server-side limits:
- Max 4 players per lobby (same as server capacity).
- JOIN_LOBBY is rejected with LOBBY_ERROR("UNKNOWN_CODE") if the code
  does not exist, or "FULL" if the target lobby already has 4 players.


--------------------------------------
5. Heartbeat / Keepalive
--------------------------------------

Server:
  - Sends PING every 5 seconds to each client that completed handshake
Client:
  - MUST respond with PONG immediately

Server drop conditions:
  - No PONG for > 10 seconds
  - TCP read() <= 0
  - Invalid packet formats


--------------------------------------
6. Server Behavior
--------------------------------------

Maximum of 4 simultaneous clients per lobby (and overall).

On disconnect, timeout, or invalid packet:
  - Close TCP socket
  - Reset client slot
  - Free slot for next player

REFUSED is advisory: server may close immediately after sending it.

Lobby-scoped broadcasts:
  - PLAYER_LIST is sent only to players in the same lobby as the target.
  - NEW_PLAYER is broadcast only to players in the same lobby as the new
    entrant.


--------------------------------------
7. Error Handling
--------------------------------------

Serialization must fail if:
  - payload size > 255

Deserialization must fail if:
  - length < 4 bytes
  - magic != 0x5254
  - declared size > actual bytes

On deserialization error, server sends REFUSED("BAD_PACKET")
and closes the connection.


--------------------------------------
8. Extensibility
--------------------------------------

New PacketType values may be added.

Clients should:
  - ignore unrecognized packet types,
  - or treat them as MESSAGE.

Changing packet format or payload >255 requires protocol version bump.


--------------------------------------
9. Security Considerations
--------------------------------------

This protocol has no encryption.

Risks:
  - Handshake forgery
  - Packet replay
  - Man-in-the-middle
  - No authentication

For production usage, TLS or shared-key MAC recommended.


--------------------------------------
10. Examples (hex)
--------------------------------------

SERVER_HELLO Payload "R-Type Server"
  52 54 01 0C 52 2D 54 79 70 65 20 53 65 72 76 65 72

CLIENT_HELLO "toto123"
  52 54 02 07 74 6F 74 6F 31 32 33

OK (player id = 10)
  52 54 03 02 00 0A

REFUSED "FULL"
  52 54 04 04 46 55 4C 4C

PING
  52 54 05 00

PONG
  52 54 06 00

CREATE_LOBBY (client → server)
  52 54 0E 00

LOBBY_OK "AB12CD"
  52 54 10 06 41 42 31 32 43 44

--------------------------------------
End of Document
--------------------------------------
