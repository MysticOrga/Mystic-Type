Mystic-Type TCP Protocol (Informal RFC)
======================================

Version: 1.0
Status: Draft
Author: Mystic-Type Networking Team
Date: 2025

--------------------------------------
1. Introduction
--------------------------------------

This document defines the Mystic-Type TCP Protocol, a lightweight
binary protocol used for:

- Client connection
- Lobby creation/join and listing
- Assignment of player ID
- Heartbeat / keepalive (PING/PONG)
- Player list broadcast within a lobby

All gameplay data is transmitted over UDP, not TCP.

--------------------------------------
2. Transport and Framing
--------------------------------------

Transport layer: TCP stream.

Each message sent over TCP is a framed binary packet defined as:

  [0-1] : header_magic  (uint16, always 0x5254 = "RT")
  [2]   : type          (uint8)
  [3]   : size          (uint8, payload length 0..255)
  [4..] : payload       (0..255 bytes)

All integers use big-endian (network byte order).

Maximum payload = 255 bytes.


--------------------------------------
3. Packet Types
--------------------------------------

PacketType enumeration:

  1 : SERVER_HELLO
  2 : (reserved, was CLIENT_HELLO)
  3 : OK (reused for lobby success)
  4 : REFUSED (generic)
  5 : PING
  6 : PONG
  7 : MESSAGE
  8 : PLAYER_LIST
  9 : NEW_PLAYER

Lobby management (TCP, new):
 10 : LOBBY_CREATE_REQ
 11 : LOBBY_CREATE_OK
 12 : LOBBY_JOIN_REQ
 13 : LOBBY_JOIN_OK
 14 : LOBBY_LOBBY_REFUSED
 15 : LOBBY_LIST_REQ
 16 : LOBBY_LIST_RESP
 17 : LOBBY_CLOSED

Details:

SERVER_HELLO (1)
  Payload: ASCII text, typically "R-Type Server"
OK (3)
  Payload: 2 bytes (player ID) + optional data depending on context
    - On lobby create/join success: [id_hi][id_lo][code0..code5]
REFUSED (4)
  Payload: ASCII reason (e.g., "FULL", "TIMEOUT", ...)
PING (5)
  No payload
PONG (6)
  No payload
MESSAGE (7)
  Free-form application-defined payload
PLAYER_LIST (8)
  Payload: [count][id_hi][id_lo][x][y]... (scoped to the current lobby)
NEW_PLAYER (9)
  Payload: [id_hi][id_lo][x][y] (scoped to the current lobby)

LOBBY_CREATE_REQ (10)
  Payload: [nameLen][name bytes...] (nameLen may be 0 if unused)

LOBBY_CREATE_OK (11)
  Payload: [id_hi][id_lo][code0..code5] (code = 6 ASCII chars A-Z0-9)

LOBBY_JOIN_REQ (12)
  Payload: [code0..code5][nameLen][name bytes...]

LOBBY_JOIN_OK (13)
  Payload: [id_hi][id_lo][code0..code5]

LOBBY_LOBBY_REFUSED (14)
  Payload: [reasonCode]
    reasonCode:
      0: unknown
      1: not_found
      2: full
      3: closed
      4: bad_payload

LOBBY_LIST_REQ (15)
  Payload: empty

LOBBY_LIST_RESP (16)
  Payload: [count] then repeated for each lobby:
    [code0..code5][players][maxPlayers][isOpen]
  count, players, maxPlayers, isOpen are 1-byte fields (0-255).

LOBBY_CLOSED (17)
  Payload: [code0..code5] (notifies members that the lobby has been closed)


--------------------------------------
4. Connection Handshake
--------------------------------------

Handshake sequence:

1) Server → SERVER_HELLO("R-Type Server")
2) Client → either:
   - LOBBY_CREATE_REQ([nameLen][name...])
   - LOBBY_JOIN_REQ([code0..5][nameLen][name...])

If valid:
3) Server → LOBBY_CREATE_OK(id, code) or LOBBY_JOIN_OK(id, code)
4) Server → PLAYER_LIST (scoped to this lobby)

On failure:
3) Server → LOBBY_LOBBY_REFUSED(reasonCode) or REFUSED("BAD_PACKET"/"TIMEOUT")
4) Server closes connection.

Refusal reasons:

- "TIMEOUT"     → no data from client within 3 seconds
- "NO_DATA"     → client closed the socket
- "BAD_PACKET"  → deserialize error, bad magic or truncated
- reasonCode    → lobby errors (not_found, full, closed, bad_payload)


--------------------------------------
5. Heartbeat / Keepalive
--------------------------------------

Server:
  - Sends PING every 5 seconds to each client that completed handshake
Client:
  - MUST respond with PONG immediately

Server drop conditions:
  - No PONG for > 10 seconds
  - TCP read() <= 0
  - Invalid packet formats


--------------------------------------
6. Server Behavior
--------------------------------------

Capacity: maximum of 4 simultaneous TCP clients (per process).

Lobby model:
  - Each client belongs to exactly one lobby (created or joined at handshake).
  - PLAYER_LIST and NEW_PLAYER are scoped to that lobby only.
  - On disconnect, the server removes the player from its lobby and may close
    the lobby if empty, notifying remaining members with LOBBY_CLOSED.

On disconnect, timeout, or invalid packet:
  - Close TCP socket
  - Reset client slot
  - Free slot for next player
  - Remove the player from its lobby (if any)

REFUSED is advisory: server may close immediately after sending it.


--------------------------------------
7. Error Handling
--------------------------------------

Serialization must fail if:
  - payload size > 255

Deserialization must fail if:
  - length < 4 bytes
  - magic != 0x5254
  - declared size > actual bytes

On deserialization error, server sends REFUSED("BAD_PACKET")
and closes the connection.


--------------------------------------
8. Extensibility
--------------------------------------

New PacketType values may be added.

Clients should:
  - ignore unrecognized packet types,
  - or treat them as MESSAGE.

Changing packet format or payload >255 requires protocol version bump.


--------------------------------------
9. Security Considerations
--------------------------------------

This protocol has no encryption.

Risks:
  - Handshake forgery
  - Packet replay
  - Man-in-the-middle
  - No authentication

For production usage, TLS or shared-key MAC recommended.


--------------------------------------
10. Examples (hex)
--------------------------------------

SERVER_HELLO Payload "R-Type Server"
  52 54 01 0C 52 2D 54 79 70 65 20 53 65 72 76 65 72

CLIENT_HELLO "toto123"
  52 54 02 07 74 6F 74 6F 31 32 33

OK (player id = 10)
  52 54 03 02 00 0A

REFUSED "FULL"
  52 54 04 04 46 55 4C 4C

PING
  52 54 05 00

PONG
  52 54 06 00

--------------------------------------
End of Document
--------------------------------------
